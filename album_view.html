<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>View Album</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-[#FFF5E1] text-[#3E2723]">

  <!-- Navbar -->
  <div id="navbar"></div>

  <div class="max-w-4xl mx-auto mt-10 bg-white p-6 rounded shadow">
    <div id="albumContainer"></div>
  </div>

  <!-- Footer -->
  <div id="footer"></div>

  <script>
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbw2ze0NZ8j8TOxt6cbVWEieT3CXAhLdZOE3q1nN72mWZDpA23e6o8kYblAXaTxvnf4U/exec"; // Replace with your actual Album App URL

    const email = localStorage.getItem("artistEmail");
    const sessionId = localStorage.getItem("sessionId");

    if (!email || !sessionId) location.href = "login.html";

    const urlParams = new URLSearchParams(window.location.search);
    const albumId = urlParams.get("id");

    async function loadComponents() {
      document.getElementById("navbar").innerHTML = await fetch("components/navbar.html").then(r => r.text());
      document.getElementById("footer").innerHTML = await fetch("components/footer.html").then(r => r.text());
    }

    async function loadAlbum() {
      const res = await fetch(WEB_APP_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ action: "getAlbum", albumId, email, sessionId })
      });

      const { success, album, message } = await res.json();

      if (!success) {
        document.getElementById("albumContainer").innerHTML = `<p class="text-red-600 font-semibold">${message || "Album not found"}</p>`;
        return;
      }

      const container = document.getElementById("albumContainer");
      container.innerHTML = `
        <img src="${album.coverURL}" class="w-full h-64 object-cover rounded mb-4" />
        <h2 class="text-3xl font-bold text-[#3B82F6] mb-2">${album.title}</h2>
        <p class="text-[#374151] mb-1">Genre: ${album.genre}</p>

        <!-- Platforms display -->
        <div class="mb-4 flex flex-wrap gap-2">
          ${(album.platforms || []).map(platform => `
            <span class="text-[#3E2723] bg-[#FFDB58] px-3 py-1 rounded text-sm font-semibold select-none">${platform}</span>
          `).join('')}
        </div>

        <p class="font-semibold mb-4">Status: ${album.status}</p>
        <ul class="mt-4 space-y-1">
          ${album.tracks.map(t => `<li>ðŸŽµ ${t.name} - <a class="text-[#3B82F6] underline" href="${t.url}" target="_blank" rel="noopener noreferrer">Listen</a></li>`).join('')}
        </ul>

        <div class="mt-6 space-x-4">
          ${album.status === "Draft" ? `
            <button onclick="submitAlbum()" class="bg-[#800000] hover:bg-[#A00000] text-white px-4 py-2 rounded">Submit for Review</button>
          ` : ""}
          ${album.status === "In Review" ? `
            <button onclick="cancelReview()" class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded">Cancel Moderation</button>
          ` : ""}
          ${album.status === "Approved" ? `
            <button onclick="requestUnlock()" class="bg-[#3B82F6] hover:bg-[#FFDB58] text-white px-4 py-2 rounded">Request Unlock</button>
          ` : ""}
        </div>
      `;
    }

    async function submitAlbum() {
      const res = await fetch(WEB_APP_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ action: "submitAlbum", albumId, email, sessionId })
      });
      const result = await res.json();
      if (result.success) location.reload();
      else alert("Failed to submit album: " + result.message);
    }

    async function cancelReview() {
      const res = await fetch(WEB_APP_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ action: "cancelReview", albumId, email, sessionId })
      });
      const result = await res.json();
      if (result.success) location.reload();
      else alert("Failed to cancel review: " + result.message);
    }

    async function requestUnlock() {
      const res = await fetch(WEB_APP_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ action: "requestUnlock", albumId, email, sessionId })
      });
      const result = await res.json();
      alert(result.success ? "Unlock request sent." : "Failed to request unlock: " + result.message);
    }

    loadComponents();
    loadAlbum();
  </script>
</body>
</html>
